# 刻意练习模板系统 - 架构设计

## 概述

本系统将主动学习阶段学习到的碎片化知识，系统化整理为刻意练习的练习骨架（模板）。

### 输入与输出

- **输入**: 碎片化知识，需要系统化整理
- **输出**: 结构化的练习模板

## 核心概念

### 模板状态流转

```
┌─────────────┐
│  待压测     │
│  (Pending)  │
└──────┬──────┘
       │
       ├───T1/T2 练习成功──→ ┌─────────────┐
       │                      │   已精通    │
       │                      │ (Mastered)  │
       │                      └─────────────┘
       │
       └───练习发现问题──→ ┌─────────────┐
                              │ 回炉重造   │
                              │  (Rework)  │
                              └──────┬──────┘
                                     │
                                     └──→ 待压测
```

### 练习层级

| 级别 | 说明 | 特点 |
|------|------|------|
| T1 | 真实场景 | 质量高，练习次数少 |
| T2 | 模拟场景 | 快速训练，自下而上构建流程 |

## 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         刻意练习系统                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐    ┌──────────────────┐    ┌─────────────────┐   │
│  │   用户输入   │───→│  意图识别器       │───→│   匹配的模板    │   │
│  └─────────────┘    └──────────────────┘    └─────────────────┘   │
│                                                     │              │
│                          ┌──────────────────────────┘              │
│                          ↓                                         │
│  ┌───────────────────────────────────────────────────────────┐    │
│  │                    模板引擎                               │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐         │    │
│  │  │ 触发器   │ │  陷阱    │ │ 工作流   │ │  技巧    │         │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘         │    │
│  └───────────────────────────────────────────────────────────┘    │
│                          ↓                                         │
│  ┌───────────────────────────────────────────────────────────┐    │
│  │                 T2 练习控制器                              │    │
│  │                                                           │    │
│  │   用户确认 ──→ 生成模拟场景 ──→ 开始练习                  │    │
│  │                              │                            │    │
│  │                              ├─── [简单问题] ──→ 直接处理 │    │
│  │                              │                            │    │
│  │                              └─── [复杂问题] ──→ V 字法  │    │
│  │                                       观察期(3分钟)       │    │
│  │                                       ↓                   │    │
│  │                                       有效性试探          │    │
│  │                                                           │    │
│  │   3 个练习一组 ──→ 计时 ──→ 完成后收集数据               │    │
│  └───────────────────────────────────────────────────────────┘    │
│                          ↓                                         │
│  ┌───────────────────────────────────────────────────────────┐    │
│  │                 反思引擎 (OKR)                             │    │
│  │                                                           │    │
│  │   聚焦有效矛盾 ──→ 目标调整 ──→ 有效性验证 ──→ 人工审核   │    │
│  └───────────────────────────────────────────────────────────┘    │
│                          ↓                                         │
│  ┌───────────────────────────────────────────────────────────┐    │
│  │                 工作流优化器                               │    │
│  │                                                           │    │
│  │   应用修改 ──→ 迭代历史 ──→ 效果验证 ──→ 回炉判断         │    │
│  └───────────────────────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 数据库表结构

### templates（模板表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键 |
| name | TEXT | 模板名称 |
| subject | TEXT | 科目 |
| chapter | TEXT | 章节 |
| status | TEXT | 状态: pending/mastered/rework |
| level | TEXT | 练习级别: T1/T2 |
| objectives | TEXT | 目标 (JSON, OKR格式) |
| triggers | TEXT | 触发器 (JSON) |
| traps | TEXT | 陷阱 (JSON) |
| workflow | TEXT | 工作流 (JSON) |
| techniques | TEXT | 技巧 (JSON) |
| created_at | TEXT | 创建时间 |
| updated_at | TEXT | 更新时间 |
| metadata | TEXT | 元数据 (JSON) |

### practice_groups（练习组表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键 |
| template_id | TEXT | 模板ID (外键) |
| started_at | TEXT | 开始时间 |
| ended_at | TEXT | 结束时间 |
| status | TEXT | 状态: in_progress/completed/paused |
| sessions | TEXT | 练习会话列表 (JSON) |

### practice_sessions（练习会话表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键 |
| group_id | TEXT | 练习组ID (外键) |
| template_id | TEXT | 模板ID (外键) |
| level | TEXT | 练习级别: T1/T2 |
| problem | TEXT | 问题描述 |
| complexity | TEXT | 复杂度: simple/complex |
| started_at | TEXT | 开始时间 |
| ended_at | TEXT | 结束时间 |
| duration | INTEGER | 耗时（秒） |
| status | TEXT | 状态: pending/observing/exploring/completed/failed |
| process_log | TEXT | 过程日志 (JSON) |
| result | TEXT | 结果 (JSON) |

### reflections（反思记录表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键 |
| group_id | TEXT | 练习组ID (外键) |
| created_at | TEXT | 创建时间 |
| focus_contradiction | TEXT | 聚焦的有效矛盾 |
| objective_adjustments | TEXT | 目标调整 (JSON, OKR格式) |
| validation_results | TEXT | 有效性验证结果 (JSON) |
| workflow_suggestions | TEXT | 工作流修改建议 (JSON) |
| status | TEXT | 状态: pending/approved/rejected/applied |

### simulated_scenarios（场景模拟表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键 |
| template_id | TEXT | 模板ID (外键) |
| title | TEXT | 场景标题 |
| description | TEXT | 场景描述 |
| complexity | TEXT | 复杂度: simple/complex |
| suggested_approach | TEXT | 建议应对方法: direct/v_shape |
| variables | TEXT | 场景变量 (JSON) |
| expected_outcome | TEXT | 预期结果 |
| created_at | TEXT | 创建时间 |

### workflow_iterations（工作流迭代记录表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键 |
| template_id | TEXT | 模板ID (外键) |
| step_id | TEXT | 步骤ID |
| before | TEXT | 迭代前内容 |
| after | TEXT | 迭代后内容 |
| reason | TEXT | 迭代原因 |
| validation | TEXT | 有效性验证 (JSON) |
| iterated_at | TEXT | 迭代时间 |

## 核心流程

### T2 练习流程

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. 场景生成                                                      │
│    - AI 根据模板生成模拟场景                                     │
│    - 确定问题复杂度（简单/复杂）                                 │
├─────────────────────────────────────────────────────────────────┤
│ 2. 用户确认开始训练                                              │
├─────────────────────────────────────────────────────────────────┤
│ 3. 根据复杂度选择处理方式                                        │
│                                                                  │
│    [简单问题]              [复杂问题 - V字应对法]                │
│    │                       │                                     │
│    │                       ├─→ 观察期（3分钟）                  │
│    │                       │   无压力思考问题的客观现实          │
│    │                       │                                     │
│    │                       └─→ 有效性试探                        │
│    │                           尝试有效的解决办法                │
├─────────────────────────────────────────────────────────────────┤
│ 4. 完成练习，记录结果                                            │
├─────────────────────────────────────────────────────────────────┤
│ 5. 3个练习一组完成后，自动收集数据进行反思                        │
└─────────────────────────────────────────────────────────────────┘
```

### 反思调整流程（OKR）

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. 练习数据收集                                                  │
│    - 成功率、得分、耗时                                          │
│    - 过程日志                                                    │
├─────────────────────────────────────────────────────────────────┤
│ 2. AI 分析，聚焦有效矛盾                                        │
│    - 识别核心问题                                                │
│    - 提出目标调整建议（OKR格式）                                 │
│    - 生成工作流修改建议                                          │
├─────────────────────────────────────────────────────────────────┤
│ 3. 自动进行有效性验证                                            │
│    - 模拟验证修改效果                                            │
│    - 评估优先级                                                  │
├─────────────────────────────────────────────────────────────────┤
│ 4. 上报人工审核                                                  │
│    - 展示分析结果                                                │
│    - 展示修改建议                                                │
├─────────────────────────────────────────────────────────────────┤
│ 5. 人工确认/修改                                                │
│    - 确认方向正确                                                │
│    - 修改不当建议                                                │
├─────────────────────────────────────────────────────────────────┤
│ 6. 应用修改，继续练习                                            │
└─────────────────────────────────────────────────────────────────┘
```

## 模板结构（核心）

```typescript
interface PracticeTemplate {
  // 基本信息
  id: string;
  name: string;
  subject: string;    // 科目
  chapter: string;    // 章节
  status: TemplateStatus;  // 状态
  level: PracticeLevel;    // 练习级别

  // 目标（OKR格式）
  objectives: Objective[];

  // 触发器
  triggers: Trigger[];     // 意图识别关键词/正则
  traps: Trap[];          // 意图识别陷阱

  // 流程
  workflow: WorkflowStep[];  // 工作流步骤

  // 技巧
  techniques: Technique[];   // 相关上下文/技巧
}
```

## 使用示例

```typescript
import { DeliberatePracticeSystem } from './src/core/template/index.js';

// 初始化系统
const system = new DeliberatePracticeSystem('./data');
await system.init();

// 创建练习流程
const result = await system.createPracticeFlow(
  '我想练习代码审查',
  async (prompt) => {
    // AI 服务调用
    return await callAI(prompt);
  }
);

if (result.template) {
  console.log('匹配的模板:', result.template.name);
  console.log('练习组ID:', result.groupId);
}
```

## 文件结构

```
src/
├── types/
│   └── template.ts              # 类型定义
├── core/
│   └── template/
│       ├── index.ts             # 系统入口
│       ├── template-engine.ts   # 模板引擎
│       ├── intent-recognizer.ts # 意图识别器
│       ├── practice-controller.ts # T2练习控制器
│       ├── reflection-engine.ts # 反思引擎（OKR）
│       └── workflow-optimizer.ts # 工作流优化器
```
